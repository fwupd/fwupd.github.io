<!--
SPDX-FileCopyrightText: fwupd Development Team

SPDX-License-Identifier: LGPL-2.1-or-later
-->

<!DOCTYPE html>
<html lang="en">
<head>
  <title>FwupdPlugin &ndash; 1.0: Plugin: UEFI Capsule</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta charset="utf-8" />

  
  <meta property="og:type" content="website"/>

  
  <meta property="og:image:width" content="256"/>
  <meta property="og:image:height" content="256"/>
  <meta property="og:image:secure_url" content="org.freedesktop.fwupd.svg"/>
  <meta property="og:image:alt" content="FwupdPlugin-1.0"/>
  

  
  <meta property="og:title" content="FwupdPlugin: Plugin: UEFI Capsule"/>
  <meta property="og:description" content="Reference for FwupdPlugin-1.0: Plugin: UEFI Capsule"/>
  <meta name="twitter:title" content="FwupdPlugin: Plugin: UEFI Capsule"/>
  <meta name="twitter:description" content="Reference for FwupdPlugin-1.0: Plugin: UEFI Capsule"/>


  
  <meta name="twitter:card" content="summary"/>

  
  
  
  

  <link rel="stylesheet" href="style.css" type="text/css" />

  

  
  <script src="urlmap_fwupdplugin.js"></script>
  
  
  <script src="fzy.js"></script>
  <script src="search.js"></script>
  
  <script src="main.js"></script>

  
</head>

<body>
  <div id="body-wrapper" tabindex="-1">

    <nav class="sidebar devhelp-hidden">
      
      <div class="section">
        <a href="index.html"><img src="org.freedesktop.fwupd.svg" class="logo"/></a>
      </div>
      
      
      <div class="search section">
        <form id="search-form" autocomplete="off">
          <input id="search-input" type="text" name="do-not-autocomplete" placeholder="Click, or press 's' to search" autocomplete="off"/>
        </form>
      </div>
      
      <div class="section namespace">
        <h3><a href="index.html">FwupdPlugin</a></h3>
        <p>API Version: 1.0</p>
        
        <p>Library Version: 2.0.1</p>
        
      </div>
      
      
      <div class="section generator">
        <p>Generated by <a href="https://gitlab.gnome.org/GNOME/gi-docgen">gi-docgen</a> 2024.1</p>
      </div>
    </nav>

    <button id="btn-to-top" class="hidden"><span class="up-arrow"></span></button>

    
<section id="main" class="content">
  
  <h4 id="title" style="display:flex;">
    Plugin: UEFI Capsule
    <a href="#title" class="anchor"></a>
    
  </h4>
  
  <section>
    <div class="docblock">
    <h2 id="introduction">Introduction<a class="md-anchor" href="#introduction" title="Permanent link"></a></h2>
<p>The Unified Extensible Firmware Interface (<span class="caps">UEFI</span>) is a specification that
defines the software interface between an <span class="caps">OS</span> and platform firmware.
With the UpdateCapsule boot service it can be used to update system&nbsp;firmware.</p>
<p>If you don&#8217;t want or need this functionality you can use the
<code>-Dplugin_uefi_capsule=disabled</code> option.</p>
<p>When this plugin is enabled, the companion <span class="caps">UEFI</span> binary may also be built from the <a href="https://github.com/fwupd/fwupd-efi">fwupd-efi</a> project if not already present on the filesystem by using the meson option <code>-Defi_binary=true</code>.</p>
<p>For this companion binary to work with secure boot, it will need to be signed by an authority trusted with shim and/or the host&nbsp;environment.</p>
<h2 id="lenovo-specific-behavior">Lenovo Specific Behavior<a class="md-anchor" href="#lenovo-specific-behavior" title="Permanent link"></a></h2>
<p>On Lenovo hardware only the boot label is set to <code>Linux-Firmware-Updater</code> rather
than &#8220;Linux Firmware Updater&#8221; (with spaces) due to long-fixed <span class="caps">EFI</span> boot manager
bugs. Many users will have these old <span class="caps">BIOS</span> versions installed and so we use the
<code>use-legacy-bootmgr-desc</code> quirk to use the safe&nbsp;name.</p>
<p>On some Lenovo hardware only one capsule is installable due to possible problems
with the UpdateCapsule coalesce operation. As soon as one <span class="caps">UEFI</span> device has been
scheduled for update the other <span class="caps">UEFI</span> devices found in the <span class="caps">ESRT</span> will be marked
as <code>updatable-hidden</code> rather than <code>updatable</code>. Rebooting will restore them so
they can be updated on next <span class="caps">OS</span>&nbsp;boot.</p>
<h2 id="firmware-format">Firmware Format<a class="md-anchor" href="#firmware-format" title="Permanent link"></a></h2>
<p>The daemon will decompress the cabinet archive and extract a firmware blob in
<span class="caps">EFI</span> capsule file&nbsp;format.</p>
<p>See the <a href="https://www.uefi.org/sites/default/files/resources/UEFI%20Spec%202_6.pdf"><span class="caps">UEFI</span> specification</a>
for&nbsp;details.</p>
<p>This plugin supports the following protocol <span class="caps">ID</span>:</p>
<ul>
<li><code>org.uefi.capsule</code></li>
</ul>
<h2 id="version-format">Version Format<a class="md-anchor" href="#version-format" title="Permanent link"></a></h2>
<p>The <span class="caps">ESRT</span> table is the way the firmware tells fwupd about what devices are updatable. Unfortunately
the information it contains is&nbsp;minimal:</p>
<ul>
<li><span class="caps">GUID</span> of the&nbsp;sub-component</li>
<li>Enumerated result of the last&nbsp;update</li>
<li>Firmware version as a <strong>32 bit unsigned&nbsp;number</strong></li>
</ul>
<p>By default, we show the <span class="caps">ESRT</span> devices as decimal or hexadecimal numbers as different vendors format
the number in different ways. When fwupd gets information about how to format the <em>raw</em> version
is converts the number into a more familiar&nbsp;form.</p>
<p>When the hardware <span class="caps">GUID</span> is static, a quirk may be appropriate, for&nbsp;example:</p>
<div class="codehilite"><pre><span></span><code>[28108d08-5027-42c2-a5b8-92d6ede9b97b]
VersionFormat = quad
</code></pre></div>

<p>As the <span class="caps">GUID</span> may be model specific, the daemon also reads the metadata and copies the version format
from that. This means that <code>fwupdmgr get-devices</code> may return the <span class="caps">UEFI</span> device as a number initially,
then once <code>fwupdmgr refresh</code> has completed it may start showing the exact same device as <code>A.B.C.D</code>,
aka <code>quad</code> format.</p>
<p>The main formats used by vendors are <code>triplet</code>, <code>quad</code>, <code>dell-bios</code> and <code>dell-bios-msb</code>.</p>
<div class="codehilite"><pre><span></span><code>0xAABBCCDD -&gt; 0xAA.0xBB.0xCCCC is `triplet`, used for Lenovo
0xAABBCCDD -&gt; 0xAA.0xBB.0xCC.0xDD is `quad`, used for HP
0xAABBCCDD -&gt; 0xBB.0xCC.0xDD is `dell-bios`, used for Dell
0xAABBCCDD -&gt; 0xAA.0xBB.0xCC is `dell-bios-msb`, used for Dell since CY24
</code></pre></div>

<p>There are more details about firmware version formats and a full list of all the different allowed
values on the <a href="https://lvfs.readthedocs.io/en/latest/metainfo.html#version-format"><span class="caps">LVFS</span></a>.</p>
<p><span class="caps">NOTE</span>: Firmware can require either the <code>quad</code> or <code>triplet</code> string version format, but it may be more
portable to depend on the number &#8212; which will also work if the metadata has not been refreshed&nbsp;yet.</p>
<h2 id="update-behavior">Update Behavior<a class="md-anchor" href="#update-behavior" title="Permanent link"></a></h2>
<h3 id="capsule-update-on-disk">Capsule update on-disk<a class="md-anchor" href="#capsule-update-on-disk" title="Permanent link"></a></h3>
<p>Described in  <a href="https://www.uefi.org/sites/default/files/resources/UEFI%20Spec%202_6.pdf"><span class="caps">UEFI</span> specification</a>
ยง 8.5.5 - Delivery of Capsules via file on Mass Storage&nbsp;device.</p>
<p>If the firmware supports this, it will be the preferred method of updating when supported.
You can explicitly disable it by by modifying
<em>DisableCapsuleUpdateOnDisk</em> in the <code>uefi_capsule</code> section of <code>/etc/fwupd/fwupd.conf</code>.</p>
<p>The spec expects runtime <em>SetVariable</em> to be available in order to enable this
feature, we need to set <code>EFI_OS_INDICATIONS_FILE_CAPSULE_DELIVERY_SUPPORTED</code>
in <em>OsIndications</em> variable to trigger processing of submitted capsule on next
reboot. However some firmware implementations (e.g U-Boot), can&#8217;t set the
variable at runtime, but ignore the variable in next reboot and apply the
capsule&nbsp;anyway.</p>
<p>The directory \<span class="caps">EFI</span>\UpdateCapsule is checked for capsules only within the <span class="caps">EFI</span>
system partition on the device specified in the active boot option determine by
reference to <em>BootNext</em> variable or <em>BootOrder</em> variable processing.  Since
setting <em>BootNext</em>, for capsule update on-disk, is not yet implemented, the only
available option is place the \<span class="caps">EFI</span>\UpdateCapsule within the <span class="caps">ESP</span> partition
indicated by the current <em>BootOrder</em>.
Note that this will be always needed if your firmware doesn&#8217;t support
<em>SetVariable</em> at runtime (even if <em>BootNext</em> functionality is&nbsp;added).</p>
<h3 id="runtime-capsule-updates">Runtime capsule updates<a class="md-anchor" href="#runtime-capsule-updates" title="Permanent link"></a></h3>
<p>The firmware is deployed when the <span class="caps">OS</span> is running, but it is only written when the
system has been restarted and the <code>fwupd*.efi</code> binary has been run. To achieve
this fwupd sets up the <span class="caps">EFI</span> <code>BootNext</code> variable, creating the new boot entry if&nbsp;required.</p>
<h2 id="guid-generation">GUID Generation<a class="md-anchor" href="#guid-generation" title="Permanent link"></a></h2>
<p>These devices use the <span class="caps">UEFI</span> <span class="caps">GUID</span> as provided in the <span class="caps">ESRT</span>. Additionally, for the
system device the <code>main-system-firmware</code> internal flag is also&nbsp;added.</p>
<p>For compatibility with Windows 10, the plugin also adds GUIDs of the form
<code>UEFI\RES_{$(esrt)}</code>.</p>
<h2 id="vendor-id-security">Vendor ID Security<a class="md-anchor" href="#vendor-id-security" title="Permanent link"></a></h2>
<p>The vendor <span class="caps">ID</span> is set from the <span class="caps">BIOS</span> vendor, for example <code>DMI:LENOVO</code> for all
devices that are not marked as supporting Firmware Management Protocol. For <span class="caps">FMP</span>
device no vendor <span class="caps">ID</span> is&nbsp;set.</p>
<h2 id="custom-efi-system-partition-esp">Custom EFI System Partition (ESP)<a class="md-anchor" href="#custom-efi-system-partition-esp" title="Permanent link"></a></h2>
<p>Since version 1.1.0 fwupd will autodetect the <span class="caps">ESP</span> if it is mounted on
<code>/boot/efi</code>, <code>/boot</code>, or <code>/efi</code>, and UDisks is available on the system. In
other cases the mount point of the <span class="caps">ESP</span> needs to be manually specified using the
option <em>EspLocation</em> in <code>/etc/fwupd/fwupd.conf</code>.</p>
<p>Setting an invalid directory will disable the fwupd&nbsp;plugin.</p>
<h2 id="quirk-use">Quirk Use<a class="md-anchor" href="#quirk-use" title="Permanent link"></a></h2>
<p>This plugin uses the following plugin-specific&nbsp;quirks:</p>
<h3 id="flagscod-indexed-filename"><code>Flags=cod-indexed-filename</code><a class="md-anchor" href="#flagscod-indexed-filename" title="Permanent link"></a></h3>
<p>Use a Capsule-on-Disk filename of <code>CapsuleUpdateFileXXXX.bin</code> rather than including the <span class="caps">ESRT</span> <span class="caps">GUID</span>.
This alternative format may be needed for some early InsydeH2O&nbsp;firmwares.</p>
<h3 id="flagsno-ux-capsule"><code>Flags=no-ux-capsule</code><a class="md-anchor" href="#flagsno-ux-capsule" title="Permanent link"></a></h3>
<p>Do not use the additional <span class="caps">UX</span>&nbsp;capsule.</p>
<h3 id="flagsuse-shim-unique"><code>Flags=use-shim-unique</code><a class="md-anchor" href="#flagsuse-shim-unique" title="Permanent link"></a></h3>
<p>Use a unique shim filename to work around a common <span class="caps">BIOS</span>&nbsp;bug.</p>
<h3 id="flagsuse-legacy-bootmgr-desc"><code>Flags=use-legacy-bootmgr-desc</code><a class="md-anchor" href="#flagsuse-legacy-bootmgr-desc" title="Permanent link"></a></h3>
<p>Use the legacy boot manager description to work around a Lenovo <span class="caps">BIOS</span>&nbsp;bug.</p>
<h3 id="flagssupports-boot-order-lock"><code>Flags=supports-boot-order-lock</code><a class="md-anchor" href="#flagssupports-boot-order-lock" title="Permanent link"></a></h3>
<p>The <span class="caps">BIOS</span> might have Boot Order Lock enabled which can cause failures when not using grub
chainloading or&nbsp;capsule-on-disk.</p>
<h3 id="flagsuse-shim-for-sb"><code>Flags=use-shim-for-sb</code><a class="md-anchor" href="#flagsuse-shim-for-sb" title="Permanent link"></a></h3>
<p>Use shim to load fwupdx64.efi when SecureBoot is turned&nbsp;on.</p>
<h3 id="flagsno-rt-set-variable"><code>Flags=no-rt-set-variable</code><a class="md-anchor" href="#flagsno-rt-set-variable" title="Permanent link"></a></h3>
<p>Do not use <span class="caps">RT</span>-&gt;SetVariable.</p>
<h3 id="flagsno-capsule-header-fixup"><code>Flags=no-capsule-header-fixup</code><a class="md-anchor" href="#flagsno-capsule-header-fixup" title="Permanent link"></a></h3>
<p>Do not prepend a plausible missing capsule&nbsp;header.</p>
<h3 id="flagsenable-debugging"><code>Flags=enable-debugging</code><a class="md-anchor" href="#flagsenable-debugging" title="Permanent link"></a></h3>
<p>Enable debugging the <span class="caps">EFI</span>&nbsp;binary.</p>
<h3 id="flagsmodify-bootorder"><code>Flags=modify-bootorder</code><a class="md-anchor" href="#flagsmodify-bootorder" title="Permanent link"></a></h3>
<p>Modify <code>BootOrder</code> as well as <code>BootNext</code> to work around <span class="caps">BIOS</span>&nbsp;bugs.</p>
<h3 id="flagscod-dell-recovery"><code>Flags=cod-dell-recovery</code><a class="md-anchor" href="#flagscod-dell-recovery" title="Permanent link"></a></h3>
<p>Use Dell customized file location for the capsule on&nbsp;disk.</p>
<h2 id="external-interface-access">External Interface Access<a class="md-anchor" href="#external-interface-access" title="Permanent link"></a></h2>
<p>This plugin&nbsp;requires:</p>
<ul>
<li>read/write access to the <span class="caps">EFI</span> system&nbsp;partition.</li>
<li>read access to <code>/sys/firmware/efi/esrt/</code></li>
<li>read access to <code>/sys/firmware/efi/fw_platform_size</code></li>
<li>read/write access to <code>/sys/firmware/efi/efivars</code></li>
</ul>
<h2 id="version-considerations">Version Considerations<a class="md-anchor" href="#version-considerations" title="Permanent link"></a></h2>
<p>This plugin has been available since fwupd version <code>0.8.0</code> but was renamed to the current name in
<code>1.5.5</code>.</p>
    </div>
  </section>
</section>


    
<div id="toc" class="toc">
  <nav aria-labelledby="toc-title">
    <p id="toc-title">Content</p>
    <ul class="toc-list">
      
        
        <li class="toc-list-item"><a href="#introduction"><span class="link-text">Introduction</span></a></li>
          
        
        <li class="toc-list-item"><a href="#lenovo-specific-behavior"><span class="link-text">Lenovo Specific Behavior</span></a></li>
          
        
        <li class="toc-list-item"><a href="#firmware-format"><span class="link-text">Firmware Format</span></a></li>
          
        
        <li class="toc-list-item"><a href="#version-format"><span class="link-text">Version Format</span></a></li>
          
        
        <li class="toc-list-item"><a href="#update-behavior"><span class="link-text">Update Behavior</span></a></li>
          
          <ul class="toc-list">
          
            <li class="toc-list-item"><a href="#capsule-update-on-disk"><span class="link-text">Capsule update on-disk</span></a></li>
          
            <li class="toc-list-item"><a href="#runtime-capsule-updates"><span class="link-text">Runtime capsule updates</span></a></li>
          
          </ul>
          
        
        <li class="toc-list-item"><a href="#guid-generation"><span class="link-text">GUID Generation</span></a></li>
          
        
        <li class="toc-list-item"><a href="#vendor-id-security"><span class="link-text">Vendor ID Security</span></a></li>
          
        
        <li class="toc-list-item"><a href="#custom-efi-system-partition-esp"><span class="link-text">Custom EFI System Partition (ESP)</span></a></li>
          
        
        <li class="toc-list-item"><a href="#quirk-use"><span class="link-text">Quirk Use</span></a></li>
          
          <ul class="toc-list">
          
            <li class="toc-list-item"><a href="#flagscod-indexed-filename"><span class="link-text">Flags=cod-indexed-filename</span></a></li>
          
            <li class="toc-list-item"><a href="#flagsno-ux-capsule"><span class="link-text">Flags=no-ux-capsule</span></a></li>
          
            <li class="toc-list-item"><a href="#flagsuse-shim-unique"><span class="link-text">Flags=use-shim-unique</span></a></li>
          
            <li class="toc-list-item"><a href="#flagsuse-legacy-bootmgr-desc"><span class="link-text">Flags=use-legacy-bootmgr-desc</span></a></li>
          
            <li class="toc-list-item"><a href="#flagssupports-boot-order-lock"><span class="link-text">Flags=supports-boot-order-lock</span></a></li>
          
            <li class="toc-list-item"><a href="#flagsuse-shim-for-sb"><span class="link-text">Flags=use-shim-for-sb</span></a></li>
          
            <li class="toc-list-item"><a href="#flagsno-rt-set-variable"><span class="link-text">Flags=no-rt-set-variable</span></a></li>
          
            <li class="toc-list-item"><a href="#flagsno-capsule-header-fixup"><span class="link-text">Flags=no-capsule-header-fixup</span></a></li>
          
            <li class="toc-list-item"><a href="#flagsenable-debugging"><span class="link-text">Flags=enable-debugging</span></a></li>
          
            <li class="toc-list-item"><a href="#flagsmodify-bootorder"><span class="link-text">Flags=modify-bootorder</span></a></li>
          
            <li class="toc-list-item"><a href="#flagscod-dell-recovery"><span class="link-text">Flags=cod-dell-recovery</span></a></li>
          
          </ul>
          
        
        <li class="toc-list-item"><a href="#external-interface-access"><span class="link-text">External Interface Access</span></a></li>
          
        
        <li class="toc-list-item"><a href="#version-considerations"><span class="link-text">Version Considerations</span></a></li>
          
        
      
    </ul>
  </nav>
</div>


    <section id="search" class="content hidden"></section>

    <footer>
    
    </footer>
  </div>
</body>
</html>