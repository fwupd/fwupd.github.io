<!--
SPDX-FileCopyrightText: 2021 GNOME Foundation

SPDX-License-Identifier: Apache-2.0 OR GPL-3.0-or-later
-->

<!--
SPDX-FileCopyrightText: 2021 GNOME Foundation

SPDX-License-Identifier: Apache-2.0 OR GPL-3.0-or-later
-->

<!DOCTYPE html>
<html lang="en">
<head>
  <title>FwupdPlugin &ndash; 1.0: Plugin: UEFI Capsule</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta charset="utf-8" />

  
  <meta property="og:type" content="website"/>

  
  <meta property="og:image:width" content="256"/>
  <meta property="og:image:height" content="256"/>
  <meta property="og:image:secure_url" content="org.freedesktop.fwupd.svg"/>
  <meta property="og:image:alt" content="FwupdPlugin-1.0"/>
  

  
  <meta property="og:title" content="FwupdPlugin: Plugin: UEFI Capsule"/>
  <meta property="og:description" content="Reference for FwupdPlugin-1.0: Plugin: UEFI Capsule"/>
  <meta name="twitter:title" content="FwupdPlugin: Plugin: UEFI Capsule"/>
  <meta name="twitter:description" content="Reference for FwupdPlugin-1.0: Plugin: UEFI Capsule"/>


  
  <meta name="twitter:card" content="summary"/>

  
  
  
  

  <link rel="stylesheet" href="style.css" type="text/css" />

  

  
  <script src="urlmap_fwupdplugin.js"></script>
  
  
  <script src="fzy.js"></script>
  <script src="search.js"></script>
  
  <script src="main.js"></script>
</head>

<body>
  <div id="body-wrapper" tabindex="-1">

    <nav class="sidebar devhelp-hidden">
      
      <div class="section">
        <img src="org.freedesktop.fwupd.svg" class="logo"/>
      </div>
      
      
      <div class="search section">
        <form id="search-form" autocomplete="off">
          <input id="search-input" type="text" name="do-not-autocomplete" placeholder="Click, or press 's' to search" autocomplete="off"/>
        </form>
      </div>
      
      <div class="section namespace">
        <h3><a href="index.html">FwupdPlugin</a></h3>
        <p>API Version: 1.0</p>
        
        <p>Library Version: 1.8.10</p>
        
      </div>
      
      
    </nav>
    
    <button id="btn-to-top" class="hidden"><span class="up-arrow"></span></button>

    
<section id="main" class="content">
  <section>
    <div class="docblock">
    <h2 id="introduction">Introduction<a class="md-anchor" href="#introduction" title="Permanent link"></a></h2>
<p>The Unified Extensible Firmware Interface (<span class="caps">UEFI</span>) is a specification that
defines the software interface between an <span class="caps">OS</span> and platform firmware.
With the UpdateCapsule boot service it can be used to update system&nbsp;firmware.</p>
<p>If you don&#8217;t want or need this functionality you can use the
<code>-Dplugin_uefi_capsule=disabled</code> option.</p>
<p>When this plugin is enabled, the companion <span class="caps">UEFI</span> binary may also be built from the <a href="https://github.com/fwupd/fwupd-efi">fwupd-efi</a> project if not already present on the filesystem.
This behavior can be overridden using the meson option <code>-Defi_binary=false</code>.</p>
<p>For this companion binary to work with secure boot, it will need to be signed by an authority trusted with shim and/or the host&nbsp;environment.</p>
<h2 id="lenovo-specific-behavior">Lenovo Specific Behavior<a class="md-anchor" href="#lenovo-specific-behavior" title="Permanent link"></a></h2>
<p>On Lenovo hardware only the boot label is set to <code>Linux-Firmware-Updater</code> rather
than &#8220;Linux Firmware Updater&#8221; (with spaces) due to long-fixed <span class="caps">EFI</span> boot manager
bugs. Many users will have these old <span class="caps">BIOS</span> versions installed and so we use the
<code>use-legacy-bootmgr-desc</code> quirk to use the safe&nbsp;name.</p>
<p>On some Lenovo hardware only one capsule is installable due to possible problems
with the UpdateCapsule coalesce operation. As soon as one <span class="caps">UEFI</span> device has been
scheduled for update the other <span class="caps">UEFI</span> devices found in the <span class="caps">ESRT</span> will be marked
as <code>updatable-hidden</code> rather than <code>updatable</code>. Rebooting will restore them so
they can be updated on next <span class="caps">OS</span>&nbsp;boot.</p>
<h2 id="firmware-format">Firmware Format<a class="md-anchor" href="#firmware-format" title="Permanent link"></a></h2>
<p>The daemon will decompress the cabinet archive and extract a firmware blob in
<span class="caps">EFI</span> capsule file&nbsp;format.</p>
<p>See the <a href="https://www.uefi.org/sites/default/files/resources/UEFI%20Spec%202_6.pdf"><span class="caps">UEFI</span> specification</a>
for&nbsp;details.</p>
<p>This plugin supports the following protocol <span class="caps">ID</span>:</p>
<ul>
<li><code>org.uefi.capsule</code></li>
</ul>
<h2 id="update-behavior">Update Behavior<a class="md-anchor" href="#update-behavior" title="Permanent link"></a></h2>
<h3 id="capsule-update-on-disk">Capsule update on-disk<a class="md-anchor" href="#capsule-update-on-disk" title="Permanent link"></a></h3>
<p>Described in  <a href="https://www.uefi.org/sites/default/files/resources/UEFI%20Spec%202_6.pdf"><span class="caps">UEFI</span> specification</a>
ยง 8.5.5 - Delivery of Capsules via file on Mass Storage&nbsp;device.</p>
<p>If the firmware supports this, it will be the preferred method of updating on
aarch64 platforms. You can explicitly disable it by by modifying
<em>DisableCapsuleUpdateOnDisk</em> in <code>/etc/fwupd/uefi_capsule.conf</code>.</p>
<p>Several models with Insyde firmware have been released where <code>OsIndications</code>
advertises support for CoD, but it simply <em>does not work</em>. For this reasons
the CoD support is only available by opt-in for x86_64 devices, and can be
specified using the <code>uefi-allow-cod</code> plugin flag for the appropriate&nbsp;HwID.</p>
<p>The spec expects runtime <em>SetVariable</em> to be available in order to enable this
feature, we need to set <code>EFI_OS_INDICATIONS_FILE_CAPSULE_DELIVERY_SUPPORTED</code>
in <em>OsIndications</em> variable to trigger processing of submitted capsule on next
reboot. However some firmware implementations (e.g U-Boot), can&#8217;t set the
variable at runtime, but ignore the variable in next reboot and apply the
capsule&nbsp;anyway.</p>
<p>The directory \<span class="caps">EFI</span>\UpdateCapsule is checked for capsules only within the <span class="caps">EFI</span>
system partition on the device specified in the active boot option determine by
reference to <em>BootNext</em> variable or <em>BootOrder</em> variable processing.  Since
setting <em>BootNext</em>, for capsule update on-disk, is not yet implemented, the only
available option is place the \<span class="caps">EFI</span>\UpdateCapsule within the <span class="caps">ESP</span> partition
indicated by the current <em>BootOrder</em>.
Note that this will be always needed if your firmware doesn&#8217;t support
<em>SetVariable</em> at runtime (even if <em>BootNext</em> functionality is&nbsp;added).</p>
<h3 id="runtime-capsule-updates">Runtime capsule updates<a class="md-anchor" href="#runtime-capsule-updates" title="Permanent link"></a></h3>
<p>The firmware is deployed when the <span class="caps">OS</span> is running, but it is only written when the
system has been restarted and the <code>fwupd*.efi</code> binary has been run. To achieve
this fwupd sets up the <span class="caps">EFI</span> <code>BootNext</code> variable, creating the new boot entry if&nbsp;required.</p>
<h2 id="guid-generation">GUID Generation<a class="md-anchor" href="#guid-generation" title="Permanent link"></a></h2>
<p>These devices use the <span class="caps">UEFI</span> <span class="caps">GUID</span> as provided in the <span class="caps">ESRT</span>. Additionally, for the
system device the <code>main-system-firmware</code> <span class="caps">GUID</span> is also&nbsp;added.</p>
<p>For compatibility with Windows 10, the plugin also adds GUIDs of the form
<code>UEFI\RES_{$(esrt)}</code>.</p>
<h2 id="vendor-id-security">Vendor ID Security<a class="md-anchor" href="#vendor-id-security" title="Permanent link"></a></h2>
<p>The vendor <span class="caps">ID</span> is set from the <span class="caps">BIOS</span> vendor, for example <code>DMI:LENOVO</code> for all
devices that are not marked as supporting Firmware Management Protocol. For <span class="caps">FMP</span>
device no vendor <span class="caps">ID</span> is&nbsp;set.</p>
<h2 id="uefi-unlock-support">UEFI Unlock Support<a class="md-anchor" href="#uefi-unlock-support" title="Permanent link"></a></h2>
<p>On some Dell systems it is possible to turn on and off <span class="caps">UEFI</span> capsule
support from within the <span class="caps">BIOS</span>.  This functionality can also be adjusted
from within the <span class="caps">OS</span> by fwupd. This requires compiling with libsmbios&nbsp;support.</p>
<p>When fwupd has been compiled with this support you will be able to enable <span class="caps">UEFI</span>
support on the device by using the <code>unlock</code> command.</p>
<h2 id="custom-efi-system-partition-esp">Custom EFI System Partition (ESP)<a class="md-anchor" href="#custom-efi-system-partition-esp" title="Permanent link"></a></h2>
<p>Since version 1.1.0 fwupd will autodetect the <span class="caps">ESP</span> if it is mounted on
<code>/boot/efi</code>, <code>/boot</code>, or <code>/efi</code>, and UDisks is available on the system. In
other cases the mount point of the <span class="caps">ESP</span> needs to be manually specified using the
option <em>EspLocation</em> in <code>/etc/fwupd/daemon.conf</code>.</p>
<p>Setting an invalid directory will disable the fwupd&nbsp;plugin.</p>
<h2 id="external-interface-access">External Interface Access<a class="md-anchor" href="#external-interface-access" title="Permanent link"></a></h2>
<p>This plugin&nbsp;requires:</p>
<ul>
<li>read/write access to the <span class="caps">EFI</span> system&nbsp;partition.</li>
<li>read access to <code>/sys/firmware/efi/esrt/</code></li>
<li>read access to <code>/sys/firmware/efi/fw_platform_size</code></li>
<li>read/write access to <code>/sys/firmware/efi/efivars</code></li>
</ul>
    </div>
  </section>
</section>


    
<div id="toc" class="toc">
  <nav aria-labelledby="toc-title">
    <p id="toc-title">Content</p>
    <ul class="toc-list">
      
        
        <li class="toc-list-item"><a href="#introduction"><span class="link-text">Introduction</span></a></li>
          
        
        <li class="toc-list-item"><a href="#lenovo-specific-behavior"><span class="link-text">Lenovo Specific Behavior</span></a></li>
          
        
        <li class="toc-list-item"><a href="#firmware-format"><span class="link-text">Firmware Format</span></a></li>
          
        
        <li class="toc-list-item"><a href="#update-behavior"><span class="link-text">Update Behavior</span></a></li>
          
          <ul class="toc-list">
          
            <li class="toc-list-item"><a href="#capsule-update-on-disk"><span class="link-text">Capsule update on-disk</span></a></li>
          
            <li class="toc-list-item"><a href="#runtime-capsule-updates"><span class="link-text">Runtime capsule updates</span></a></li>
          
          </ul>
          
        
        <li class="toc-list-item"><a href="#guid-generation"><span class="link-text">GUID Generation</span></a></li>
          
        
        <li class="toc-list-item"><a href="#vendor-id-security"><span class="link-text">Vendor ID Security</span></a></li>
          
        
        <li class="toc-list-item"><a href="#uefi-unlock-support"><span class="link-text">UEFI Unlock Support</span></a></li>
          
        
        <li class="toc-list-item"><a href="#custom-efi-system-partition-esp"><span class="link-text">Custom EFI System Partition (ESP)</span></a></li>
          
        
        <li class="toc-list-item"><a href="#external-interface-access"><span class="link-text">External Interface Access</span></a></li>
          
        
      
    </ul>
  </nav>
</div>


    <section id="search" class="content hidden"></section>

    <footer>
    
    </footer>
  </div>
</body>
</html>