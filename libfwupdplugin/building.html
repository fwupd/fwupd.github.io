<!--
SPDX-FileCopyrightText: fwupd Development Team

SPDX-License-Identifier: LGPL-2.1-or-later
-->

<!DOCTYPE html>
<html lang="en">
<head>
  <title>FwupdPlugin &ndash; 1.0: Building &amp; Debugging fwupd</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta charset="utf-8" />

  
  <meta property="og:type" content="website"/>

  
  <meta property="og:image:width" content="256"/>
  <meta property="og:image:height" content="256"/>
  <meta property="og:image:secure_url" content="org.freedesktop.fwupd.svg"/>
  <meta property="og:image:alt" content="FwupdPlugin-1.0"/>
  

  
  <meta property="og:title" content="FwupdPlugin: Building &amp; Debugging fwupd"/>
  <meta property="og:description" content="Reference for FwupdPlugin-1.0: Building &amp; Debugging fwupd"/>
  <meta name="twitter:title" content="FwupdPlugin: Building &amp; Debugging fwupd"/>
  <meta name="twitter:description" content="Reference for FwupdPlugin-1.0: Building &amp; Debugging fwupd"/>


  
  <meta name="twitter:card" content="summary"/>

  
  
  
  

  <link rel="stylesheet" href="style.css" type="text/css" />

  

  
  <script src="urlmap_fwupdplugin.js"></script>
  
  
  <script src="fzy.js"></script>
  <script src="search.js"></script>
  
  <script src="main.js"></script>

  
</head>

<body>
  <div id="body-wrapper" tabindex="-1">

    <nav class="sidebar devhelp-hidden">
      
      <div class="section">
        <a href="index.html"><img src="org.freedesktop.fwupd.svg" class="logo"/></a>
      </div>
      
      
      <div class="search section">
        <form id="search-form" autocomplete="off">
          <input id="search-input" type="text" name="do-not-autocomplete" placeholder="Click, or press 's' to search" autocomplete="off"/>
        </form>
      </div>
      
      <div class="section namespace">
        <h3><a href="index.html">FwupdPlugin</a></h3>
        <p>API Version: 1.0</p>
        
        <p>Library Version: 2.0.2</p>
        
      </div>
      
      
      <div class="section generator">
        <p>Generated by <a href="https://gitlab.gnome.org/GNOME/gi-docgen">gi-docgen</a> 2024.1</p>
      </div>
    </nav>

    <button id="btn-to-top" class="hidden"><span class="up-arrow"></span></button>

    
<section id="main" class="content">
  
  <h4 id="title" style="display:flex;">
    Building &amp; Debugging fwupd
    <a href="#title" class="anchor"></a>
    
  </h4>
  
  <section>
    <div class="docblock">
    <p>These instructons below can either be used by the silicon vendor, or the consulting company to debug existing and new plugins. Sometimes new hardware is only supported in the development version of fwupd which may not even be available as a Snap or Flatpak&nbsp;yet.</p>
<h2 id="prerequisites">Prerequisites<a class="md-anchor" href="#prerequisites" title="Permanent link"></a></h2>
<ul>
<li>
<p>A <span class="caps">PC</span> with Linux (preferably the latest version of Fedora) installed bare metal (i.e. not in VirtualBox or&nbsp;VMWare)</p>
</li>
<li>
<p>Working access to the&nbsp;internet</p>
</li>
<li>
<p>A user account (we’ll use <code>u</code> as the example here) with administrator&nbsp;permissions</p>
</li>
</ul>
<h2 id="setup-fwupd-development-environment">Setup fwupd development environment<a class="md-anchor" href="#setup-fwupd-development-environment" title="Permanent link"></a></h2>
<p>A fwupd development environment is setup in a <a href="https://virtualenv.pypa.io/en/latest/user_guide.html">virtualenv</a> to avoid development work for fwupd from conflicting with any system fwupd installation. All builds will occur in <code>venv/build</code> and all installs in <code>venv/dist</code>.
To set it up follow the below&nbsp;steps:</p>
<div class="codehilite"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>~
git<span class="w"> </span>clone<span class="w"> </span>https://github.com/fwupd/fwupd.git
<span class="nb">cd</span><span class="w"> </span>fwupd
./contrib/setup
</code></pre></div>

<h2 id="building">Building<a class="md-anchor" href="#building" title="Permanent link"></a></h2>
<p>After the development environment has been setup you can enter it by&nbsp;running:</p>
<div class="codehilite"><pre><span></span><code><span class="nb">source</span><span class="w"> </span>venv/bin/activate
</code></pre></div>

<p>You can tell you are in the development environment by looking at the start of your prompt for this&nbsp;prefix:</p>
<div class="codehilite"><pre><span></span><code>(fwupd)
</code></pre></div>

<p>To build the project a script is included that will configure and build the project with default&nbsp;settings.</p>
<div class="codehilite"><pre><span></span><code>build-fwupd
</code></pre></div>

<p>To run the project test suite a script is&nbsp;included:</p>
<div class="codehilite"><pre><span></span><code>test-fwupd
</code></pre></div>

<p>If you want to leave the development environment at any time you can&nbsp;run:</p>
<div class="codehilite"><pre><span></span><code>deactivate
</code></pre></div>

<h2 id="running-binaries">Running binaries<a class="md-anchor" href="#running-binaries" title="Permanent link"></a></h2>
<p>The fwupd project is split into three main&nbsp;components:</p>
<ol>
<li>
<p><strong>fwupd</strong>: The binary that’s running in the background, as&nbsp;root</p>
</li>
<li>
<p><strong>fwupdmgr</strong>: The client tool that end-users use to interact with the running <code>fwupd</code> binary, as a normal&nbsp;user</p>
</li>
<li>
<p><strong>fwupdtool</strong>: The debugging tool developers use to find problems and to run new code, as&nbsp;root</p>
</li>
</ol>
<p>The <code>fwupdtool</code> binary does most of the things that <code>fwupdmgr</code> does, but without talking to the system fwupd instance. It is a lot easier to run <code>fwupdtool</code> with just one plugin (e.g. <code>--plugins vli</code>) than running the daemon and all the plugins. You might have to wait 5 seconds and then read thousands of lines of debugging to see the <code>printf()</code> you added in a new plugin with the daemon, but with <code>fwupdtool --plugins vli --verbose get-devices</code> it’ll be in a few lines, and&nbsp;instant.</p>
<p>Within the development environment wrappers have been setup to allow launching <code>fwupd</code>, <code>fwupdtool</code> or <code>fwupdmgr</code> very similar to a host&nbsp;system.</p>
<p>There are 3 main differences to&nbsp;note:</p>
<ol>
<li>The <code>systemd</code> service will not run.  That means that the daemon needs to be manually launched in the&nbsp;environment.</li>
<li>dbus <em>activation</em> doesn&#8217;t work.  This mean that if you are testing the daemon (<code>fwupd</code>) and client (<code>fwupdmgr</code>) interaction you need to have two terminal tabs opened each in the development environment activated. One tab would run the daemon, and one would run the&nbsp;client.</li>
<li><code>fwupd</code> and <code>fwupdtool</code> will be automatically started as root (<span class="caps">IE</span> with <code>sudo</code>).</li>
</ol>
<p>With those differences in mind all 3 binaries can just be launched like&nbsp;normal:</p>
<div class="codehilite"><pre><span></span><code>fwupdtool<span class="w"> </span>get-devices
</code></pre></div>

<div class="codehilite"><pre><span></span><code>fwupd
</code></pre></div>

<div class="codehilite"><pre><span></span><code>fwupdmgr<span class="w"> </span>get-devices
</code></pre></div>

<h2 id="using-fwupdtool">Using fwupdtool<a class="md-anchor" href="#using-fwupdtool" title="Permanent link"></a></h2>
<p>To get the list of devices from one specific plugin I would&nbsp;do:</p>
<div class="codehilite"><pre><span></span><code>fwupdtool<span class="w"> </span>--plugins<span class="w"> </span>vli<span class="w"> </span>get-devices<span class="w"> </span>--verbose
</code></pre></div>

<p>This outputs lots of text onto the console&nbsp;like:</p>
<div class="codehilite"><pre><span></span><code>10:51:49:0584 FuMain               Lenovo ThinkPad WS Dock
 DeviceId:             73ef80b60058b4f18549921520bfd94eaf18710a
 Guid:                 dd1f77bd-88ef-5293-9e34-1fe5ce187658 &lt;- USB\VID_17EF&amp;PID_305A&amp;REV_5011
 Guid:                 1c09a12d-e58a-5b4d-84af-ee3eb4c3c68b &lt;- USB\VID_17EF&amp;PID_305A
 Guid:                 6201fecc-1641-51f6-a6d2-38a06d5476bf &lt;- VLI_USBHUB\SPI_C220
 Guid:                 c9caa540-6e27-5d40-a322-47eaeef84df0 &lt;- USB\VID_17EF&amp;PID_305A&amp;SPI_C220&amp;REV_5011
 Guid:                 cfa1e12c-4eb9-5338-8b23-02acc5423ccb &lt;- USB\VID_17EF&amp;PID_305A&amp;SPI_C220
 Summary:              USB 3.x Hub
 Plugin:               vli
 Protocol:             com.vli.usbhub
 Flags:                updatable|registered|can-verify|can-verify-image
 Vendor:               LENOVO
 VendorId:             USB:0x17EF
 Version:              50.11
 VersionFormat:        bcd
 Icon:                 audio-card
 InstallDuration:      10
 Created:              2019-12-20
</code></pre></div>

<p>Using fwupdtool raw firmware blob (i.e. not the cabinet archive with metadata) can be installed on the device&nbsp;using:</p>
<div class="codehilite"><pre><span></span><code>fwupdtool<span class="w"> </span>--verbose<span class="w"> </span>--plugins<span class="w"> </span>vli<span class="w"> </span><span class="se">\</span>
<span class="w"> </span>install-blob<span class="w"> </span>/home/u/the-firmware.bin<span class="w"> </span>73ef80b60058b4f18549921520bfd94eaf18710a
</code></pre></div>

<h2 id="firmware-parsing">Firmware Parsing<a class="md-anchor" href="#firmware-parsing" title="Permanent link"></a></h2>
<p>You can also parse the raw .bin files using <code>fwupdtool</code> which has access to all the available firmware parsers built into all plugins. For&nbsp;example:</p>
<div class="codehilite"><pre><span></span><code>fwupdtool<span class="w"> </span>firmware-parse<span class="w"> </span>/home/user/VL105_APP6_8C_09_08_06_20190815.bin
Choose<span class="w"> </span>a<span class="w"> </span>firmware<span class="w"> </span>type:
<span class="m">0</span>.<span class="w"> </span>Cancel
<span class="m">1</span>.<span class="w"> </span>conexant
<span class="m">2</span>.<span class="w"> </span>8bitdo
<span class="m">3</span>.<span class="w"> </span>synaprom
<span class="m">4</span>.<span class="w"> </span>rmi
<span class="m">5</span>.<span class="w"> </span>wacom
<span class="m">6</span>.<span class="w"> </span>vli-pd
<span class="m">7</span>.<span class="w"> </span>raw
<span class="m">8</span>.<span class="w"> </span>altos
<span class="m">9</span>.<span class="w"> </span>srec
<span class="m">10</span>.<span class="w"> </span>ihex
<span class="m">11</span>.<span class="w"> </span>vli-usbhub
<span class="m">12</span>.<span class="w"> </span>vli-usbhub-pd
<span class="m">12</span>&lt;enter&gt;
FuVliUsbhubPdFirmware:
Version:<span class="w">                 </span><span class="m">140</span>.9.8.6
ChipId:<span class="w">                  </span>VL105
VID:<span class="w">                     </span>0x2109
PID:<span class="w">                     </span>0x105
<span class="w"> </span>FuFirmwareImage:
<span class="w"> </span>Data:<span class="w">                  </span>0xc000
</code></pre></div>

<h2 id="using-fwupdmgr">Using fwupdmgr<a class="md-anchor" href="#using-fwupdmgr" title="Permanent link"></a></h2>
<p>You can perform the end-to-end tests with two terminals open to the fwupd development environment. In the first&nbsp;do:</p>
<div class="codehilite"><pre><span></span><code>fwupd<span class="w"> </span>--verbose
</code></pre></div>

<p>and in the second you can&nbsp;do:</p>
<div class="codehilite"><pre><span></span><code>fwupdmgr<span class="w"> </span>install<span class="w"> </span>~/foo.cab
</code></pre></div>

<p>This will send the firmware archive from the locally built <code>fwupdmgr</code> to the locally built daemon using a file descriptor, which will call the new plugin code with the firmware blob in the archive. The daemon terminal will also show lots of useful debugging during this&nbsp;process.</p>
<h2 id="using-visual-studio-code-to-build-and-test">Using Visual Studio code to build and test<a class="md-anchor" href="#using-visual-studio-code-to-build-and-test" title="Permanent link"></a></h2>
<p>During build time a set of tasks will have been created for use with Visual Studio&nbsp;Code.</p>
<p>The default build task which is triggered by using <em>ctrl-shift-b</em> will build the project with default settings.
The default test task can be triggered from the command palette to run the test suite.
Open the command palette with <em>ctrl-shift-p</em> and type <strong>Run test task</strong> and hit enter. This will launch the daemon in a terminal window.
<img src="test_task.png" width="286" alt="test task screenshot"></p>
<h2 id="using-visual-studio-code-to-debug">Using Visual Studio Code to debug<a class="md-anchor" href="#using-visual-studio-code-to-debug" title="Permanent link"></a></h2>
<p>The <a href="https://code.visualstudio.com/Docs/editor/debugging">debugger</a> that is part of <a href="https://code.visualstudio.com/">Visual Studio Code</a> is really helpful for debugging issues.
During build time a set of launch targets will have been created for use with Visual Studio Code.
All 3 binaries have the ability be launched with a debugger attached as a <strong>user</strong> by using <code>DEBUG=1</code> in the&nbsp;environment.</p>
<h3 id="debugging-fwupdtool-and-fwupdmgr">debugging <code>fwupdtool</code> and <code>fwupdmgr</code><a class="md-anchor" href="#debugging-fwupdtool-and-fwupdmgr" title="Permanent link"></a></h3>
<p>For example to debug <code>fwupdtool</code> you would launch it like&nbsp;this:</p>
<div class="codehilite"><pre><span></span><code><span class="o">(</span>fwupd<span class="o">)</span><span class="w"> </span>u@fedora:~/fwupd$<span class="w"> </span><span class="nv">DEBUG</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>fwupdtool<span class="w"> </span>get-devices
Process<span class="w"> </span>/home/u/fwupd/venv/bin/../dist/bin/fwupdtool<span class="w"> </span>created<span class="p">;</span><span class="w"> </span><span class="nv">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">595311</span>
Listening<span class="w"> </span>on<span class="w"> </span>port<span class="w"> </span><span class="m">9091</span>
</code></pre></div>

<p>This will configure <code>gdbserver</code> to listen on a local port waiting for a debugger to&nbsp;connect.</p>
<p>Launch vscode in the same directory as the Git checkout. After it&#8217;s launched, set a source&nbsp;breakpoint.</p>
<p><img src="debug_breakpoint.png" width="720" alt="debug breakpoint screenshot"></p>
<p>Then use the run and debug button (or <em>ctrl-shift-d</em>) to open up the debugger. From the debugger choose the tool to&nbsp;use.</p>
<p><img src="debug_tool_selector.png" width="720" alt="debug tool selector screenshot"></p>
<p>Press the green start button (or use <em>F5</em>) to start debugging. The debugger will attach to the process you launched and stop where you left&nbsp;off.</p>
<p><img alt="debugger attached" src="debug_attached.png" /></p>
<h3 id="debugging-fwupd-daemon">debugging fwupd (daemon)<a class="md-anchor" href="#debugging-fwupd-daemon" title="Permanent link"></a></h3>
<p>For debugging the daemon, a helper task is also included to launch the daemon with the <code>DEBUG</code> environment variable set within&nbsp;vscode.</p>
<p>Open the command palette with <em>ctrl-shift-p</em> and type <strong>Run task</strong> and hit enter. Select the <code>gdbserver-fwupd</code> task.
This will launch the daemon in a terminal window.
<img src="debug_task.png" width="186" alt="debug task screenshot"></p>
<p>Then use the run and debug button (or <em>ctrl-shift-d</em>) to open up the debugger. From the debugger choose <code>gdbserver (fwupd)</code>.</p>
<p><img src="debug_tool_selector.png" width="720" alt="debug tool selector screenshot"></p>
    </div>
  </section>
</section>


    
<div id="toc" class="toc">
  <nav aria-labelledby="toc-title">
    <p id="toc-title">Content</p>
    <ul class="toc-list">
      
        
        <li class="toc-list-item"><a href="#prerequisites"><span class="link-text">Prerequisites</span></a></li>
          
        
        <li class="toc-list-item"><a href="#setup-fwupd-development-environment"><span class="link-text">Setup fwupd development environment</span></a></li>
          
        
        <li class="toc-list-item"><a href="#building"><span class="link-text">Building</span></a></li>
          
        
        <li class="toc-list-item"><a href="#running-binaries"><span class="link-text">Running binaries</span></a></li>
          
        
        <li class="toc-list-item"><a href="#using-fwupdtool"><span class="link-text">Using fwupdtool</span></a></li>
          
        
        <li class="toc-list-item"><a href="#firmware-parsing"><span class="link-text">Firmware Parsing</span></a></li>
          
        
        <li class="toc-list-item"><a href="#using-fwupdmgr"><span class="link-text">Using fwupdmgr</span></a></li>
          
        
        <li class="toc-list-item"><a href="#using-visual-studio-code-to-build-and-test"><span class="link-text">Using Visual Studio code to build and test</span></a></li>
          
        
        <li class="toc-list-item"><a href="#using-visual-studio-code-to-debug"><span class="link-text">Using Visual Studio Code to debug</span></a></li>
          
          <ul class="toc-list">
          
            <li class="toc-list-item"><a href="#debugging-fwupdtool-and-fwupdmgr"><span class="link-text">debugging fwupdtool and fwupdmgr</span></a></li>
          
            <li class="toc-list-item"><a href="#debugging-fwupd-daemon"><span class="link-text">debugging fwupd (daemon)</span></a></li>
          
          </ul>
          
        
      
    </ul>
  </nav>
</div>


    <section id="search" class="content hidden"></section>

    <footer>
    
    </footer>
  </div>
</body>
</html>