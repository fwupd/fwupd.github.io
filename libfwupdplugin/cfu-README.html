<!--
SPDX-FileCopyrightText: fwupd Development Team

SPDX-License-Identifier: LGPL-2.1-or-later
-->

<!DOCTYPE html>
<html lang="en">
<head>
  <title>FwupdPlugin &ndash; 1.0: Plugin: CFU - Component Firmware Update</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta charset="utf-8" />

  
  <meta property="og:type" content="website"/>

  
  <meta property="og:image:width" content="256"/>
  <meta property="og:image:height" content="256"/>
  <meta property="og:image:secure_url" content="org.freedesktop.fwupd.svg"/>
  <meta property="og:image:alt" content="FwupdPlugin-1.0"/>
  

  
  <meta property="og:title" content="FwupdPlugin: Plugin: CFU - Component Firmware Update"/>
  <meta property="og:description" content="Reference for FwupdPlugin-1.0: Plugin: CFU - Component Firmware Update"/>
  <meta name="twitter:title" content="FwupdPlugin: Plugin: CFU - Component Firmware Update"/>
  <meta name="twitter:description" content="Reference for FwupdPlugin-1.0: Plugin: CFU - Component Firmware Update"/>


  
  <meta name="twitter:card" content="summary"/>

  
  
  
  

  <link rel="stylesheet" href="style.css" type="text/css" />

  

  
  <script src="urlmap_fwupdplugin.js"></script>
  
  
  <script src="fzy.js"></script>
  <script src="search.js"></script>
  
  <script src="main.js"></script>
</head>

<body>
  <div id="body-wrapper" tabindex="-1">

    <nav class="sidebar devhelp-hidden">
      
      <div class="section">
        <img src="org.freedesktop.fwupd.svg" class="logo"/>
      </div>
      
      
      <div class="search section">
        <form id="search-form" autocomplete="off">
          <input id="search-input" type="text" name="do-not-autocomplete" placeholder="Click, or press 's' to search" autocomplete="off"/>
        </form>
      </div>
      
      <div class="section namespace">
        <h3><a href="index.html">FwupdPlugin</a></h3>
        <p>API Version: 1.0</p>
        
        <p>Library Version: 1.9.5</p>
        
      </div>
      
      
      <div class="section generator">
        <p>Generated by <a href="https://gitlab.gnome.org/GNOME/gi-docgen">gi-docgen</a> 2023.1</p>
      </div>
    </nav>

    <button id="btn-to-top" class="hidden"><span class="up-arrow"></span></button>

    
<section id="main" class="content">
  <section>
    <div class="docblock">
    <h2 id="introduction">Introduction<a class="md-anchor" href="#introduction" title="Permanent link"></a></h2>
<p><span class="caps">CFU</span> is a protocol from Microsoft to make it easy to install firmware on <span class="caps">HID</span>&nbsp;devices.</p>
<p>See <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/cfu/cfu-specification">https://docs.microsoft.com/en-us/windows-hardware/drivers/cfu/cfu-specification</a> for more&nbsp;details.</p>
<p>This plugin supports the following protocol <span class="caps">ID</span>:</p>
<ul>
<li><code>com.microsoft.cfu</code></li>
</ul>
<h2 id="implementation-notes">Implementation Notes<a class="md-anchor" href="#implementation-notes" title="Permanent link"></a></h2>
<p><span class="caps">CFU</span> has a pre-download phase that is used to send the firmware <em>offer</em> to the microcontroller, so the
device can check if the firmware is required and&nbsp;compatible.</p>
<p><span class="caps">CFU</span> also requires devices to be able to transfer the entire new transfer mode in runtime mode.
The pre-download “offer” allows the device to check any sub-components attached (e.g. other devices
attached to the SoC) and forces it to do dependency resolution in case sub-components have to be
updated in a specific&nbsp;order.</p>
<p>Pushing the dependency resolution down to the device means the low-power device has to do all the
version comparisons and also know all the logic with regard to protocol incompatibilities.
The end-user could be in a position where the device firmware needs to be updated so that it “knows”
about the new protocol restrictions, which are needed to update the device and the things attached
in the right order in a subsequent update.
If the user always updates the device to the latest version, the factory-default running version
<em>might yet know</em> about the new restrictions.
It is therefore imperative that all previous versions are tested being updated <em>from</em>.</p>
<p>Something that we support in fwupd is being able to restrict the peripheral device firmware to a
specific <span class="caps">SMBIOS</span> <span class="caps">CHID</span> or a system firmware vendor, which lets vendors solve the <em>same hardware in
different chassis, with custom firmware</em> problem.
Using <span class="caps">CFU</span> in Microsoft Windows also means that the peripheral is unaware of the other devices in the
system, so for instance couldn’t only install a new firmware version for only new builds of Windows
for&nbsp;example.</p>
<p>A few other consideration for vendors is the doubling of flash storage required to do an runtime
transfer, the extra power budget of being woken up to process the <em>offer</em> and providing enough bulk
power to stay alive if <em>unplugged</em> during a A/B swap.
On most existing hardware the easiest way to implement <span class="caps">CFU</span> is an additional <span class="caps">ARM</span> micro-controller
to act as a <span class="caps">CFU</span> “bridge” for legacy silicon. The <span class="caps">CFU</span> “bridge” could also do signing and encryption.
<span class="caps">CFU</span> does not define any standard way to encrypt and sign firmware, or to detect if devices have any
firmware verification capabilities and so this too will need to be set per-device either in the
metadata or in the quirk&nbsp;file.</p>
<p><span class="caps">CFU</span> also downloads in the runtime mode in the background, at a maximum of 52 bytes per <span class="caps">HID</span> request
and response.
This means even small updates will take a long time to complete due to the huge number of <span class="caps">USB</span> control
transfers required.
The specification also doesn&#8217;t specify the <span class="caps">HID</span> reports to use, so it all needs to be hardcoded
per-device unless the exact same defaults are used as in <code>CFU/Tools/ComponentFirmwareUpdateStandAloneToolSample/protocolCfgExample.cfg</code>.</p>
<p>In fwupd these can be set as quirks in <code>cfu.quirk</code>.</p>
<p>The included <code>https://github.com/fwupd/fwupd/blob/main/contrib/cfu-inf-to-quirk.py</code> script may be
useful to convert an existing <code>.inf</code> file to fwupd <code>.quirk</code> format.</p>
<h2 id="firmware-format">Firmware Format<a class="md-anchor" href="#firmware-format" title="Permanent link"></a></h2>
<p>Due to the one-shot way fwupd deploys firmware, the daemon only deals with one “payload” per
update. The offer and payload currently have to be combined in an archive where they are
transferred to the device one after the&nbsp;other.</p>
<p>The files in the firmware archive therefore should have the extensions <code>.offer.bin</code> and <code>.payload.bin</code>.</p>
<h2 id="guid-generation">GUID Generation<a class="md-anchor" href="#guid-generation" title="Permanent link"></a></h2>
<p>These devices use standard <span class="caps">USB</span> DeviceInstanceId values, as well as two extra for the component <span class="caps">ID</span>
and the bank,&nbsp;e.g.</p>
<ul>
<li><code>HIDRAW\VEN_17EF&amp;DEV_7226&amp;CID_01&amp;BANK_1</code></li>
<li><code>HIDRAW\VEN_17EF&amp;DEV_7226&amp;CID_01</code></li>
<li><code>HIDRAW\VEN_17EF&amp;DEV_7226</code></li>
</ul>
<h2 id="quirk-use">Quirk Use<a class="md-anchor" href="#quirk-use" title="Permanent link"></a></h2>
<p>This plugin uses the following plugin-specific&nbsp;quirks:</p>
<h3 id="cfuversiongetreport">CfuVersionGetReport<a class="md-anchor" href="#cfuversiongetreport" title="Permanent link"></a></h3>
<p>The <span class="caps">HID</span> report usage to use when parsing the response of <code>GET_FIRMWARE_VERSION</code>.</p>
<p>This usually corresponds to the <code>VersionsFeatureValueCapabilityUsageRangeMinimum</code> value
set in the <code>.inf</code> file.</p>
<p>Since:&nbsp;1.9.1</p>
<h3 id="cfuoffersetreport">CfuOfferSetReport<a class="md-anchor" href="#cfuoffersetreport" title="Permanent link"></a></h3>
<p>The <span class="caps">HID</span> report usage to use when sending the request for <code>FIRMWARE_UPDATE_OFFER</code>.</p>
<p>This usually corresponds to the <code>OfferOutputValueCapabilityUsageRangeMinimum</code> value
set in the <code>.inf</code> file.</p>
<p>Since:&nbsp;1.9.1</p>
<h3 id="cfuoffergetreport">CfuOfferGetReport<a class="md-anchor" href="#cfuoffergetreport" title="Permanent link"></a></h3>
<p>The <span class="caps">HID</span> report usage to use when parsing the response of <code>FIRMWARE_UPDATE_OFFER</code>.</p>
<p>This usually corresponds to the <code>OfferInputValueCapabilityUsageRangeMinimum</code> value
set in the <code>.inf</code> file.</p>
<p>Since:&nbsp;1.9.1</p>
<h3 id="cfucontentsetreport">CfuContentSetReport<a class="md-anchor" href="#cfucontentsetreport" title="Permanent link"></a></h3>
<p>The <span class="caps">HID</span> report usage to use when sending the request for <code>FIRMWARE_UPDATE_CONTENT</code>.</p>
<p>This usually corresponds to the <code>PayloadOutputValueCapabilityUsageRangeMinimum</code> value
set in the <code>.inf</code> file.</p>
<p>Since:&nbsp;1.9.1</p>
<h3 id="cfucontentgetreport">CfuContentGetReport<a class="md-anchor" href="#cfucontentgetreport" title="Permanent link"></a></h3>
<p>The <span class="caps">HID</span> report usage to use when parsing the response of <code>FIRMWARE_UPDATE_CONTENT</code>.</p>
<p>This usually corresponds to the <code>PayloadInputValueCapabilityUsageRangeMinimum</code> value
set in the <code>.inf</code> file.</p>
<p>Since:&nbsp;1.9.1</p>
<h2 id="update-behavior">Update Behavior<a class="md-anchor" href="#update-behavior" title="Permanent link"></a></h2>
<p>The device has to support runtime updates and does not have a detach-into-bootloader mode &#8212; but
after the install has completed the device still has to reboot into the new&nbsp;firmware.</p>
<h2 id="vendor-id-security">Vendor ID Security<a class="md-anchor" href="#vendor-id-security" title="Permanent link"></a></h2>
<p>The vendor <span class="caps">ID</span> is set from the <span class="caps">USB</span> vendor, in this instance set to <code>HIDRAW:0x17EF</code></p>
<h2 id="external-interface-access">External Interface Access<a class="md-anchor" href="#external-interface-access" title="Permanent link"></a></h2>
<p>This plugin requires read/write access to <code>/dev/bus/usb</code>.</p>
<h2 id="version-considerations">Version Considerations<a class="md-anchor" href="#version-considerations" title="Permanent link"></a></h2>
<p>This plugin has been available since fwupd version <code>1.7.1</code>.</p>
    </div>
  </section>
</section>


    
<div id="toc" class="toc">
  <nav aria-labelledby="toc-title">
    <p id="toc-title">Content</p>
    <ul class="toc-list">
      
        
        <li class="toc-list-item"><a href="#introduction"><span class="link-text">Introduction</span></a></li>
          
        
        <li class="toc-list-item"><a href="#implementation-notes"><span class="link-text">Implementation Notes</span></a></li>
          
        
        <li class="toc-list-item"><a href="#firmware-format"><span class="link-text">Firmware Format</span></a></li>
          
        
        <li class="toc-list-item"><a href="#guid-generation"><span class="link-text">GUID Generation</span></a></li>
          
        
        <li class="toc-list-item"><a href="#quirk-use"><span class="link-text">Quirk Use</span></a></li>
          
          <ul class="toc-list">
          
            <li class="toc-list-item"><a href="#cfuversiongetreport"><span class="link-text">CfuVersionGetReport</span></a></li>
          
            <li class="toc-list-item"><a href="#cfuoffersetreport"><span class="link-text">CfuOfferSetReport</span></a></li>
          
            <li class="toc-list-item"><a href="#cfuoffergetreport"><span class="link-text">CfuOfferGetReport</span></a></li>
          
            <li class="toc-list-item"><a href="#cfucontentsetreport"><span class="link-text">CfuContentSetReport</span></a></li>
          
            <li class="toc-list-item"><a href="#cfucontentgetreport"><span class="link-text">CfuContentGetReport</span></a></li>
          
          </ul>
          
        
        <li class="toc-list-item"><a href="#update-behavior"><span class="link-text">Update Behavior</span></a></li>
          
        
        <li class="toc-list-item"><a href="#vendor-id-security"><span class="link-text">Vendor ID Security</span></a></li>
          
        
        <li class="toc-list-item"><a href="#external-interface-access"><span class="link-text">External Interface Access</span></a></li>
          
        
        <li class="toc-list-item"><a href="#version-considerations"><span class="link-text">Version Considerations</span></a></li>
          
        
      
    </ul>
  </nav>
</div>


    <section id="search" class="content hidden"></section>

    <footer>
    
    </footer>
  </div>
</body>
</html>